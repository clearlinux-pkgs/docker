From 80c2a16f3d628856c2f95433424f84583c70724b Mon Sep 17 00:00:00 2001
From: Jose Carlos Venegas Munoz <jose.carlos.venegas.munoz@intel.com>
Date: Sun, 14 May 2017 23:27:26 +0000
Subject: [PATCH] dockerd: Automatic Clear Contaiers runtime detection

Signed-off-by: Jose Carlos Venegas Munoz <jose.carlos.venegas.munoz@intel.com>
---
 cmd/dockerd/config_common_unix.go |  2 +-
 cmd/dockerd/daemon.go             |  1 +
 daemon/config/cc-daemon.go        | 69 +++++++++++++++++++++++++++++++++++++++
 daemon/config/config.go           |  5 +++
 daemon/daemon_unix.go             |  4 +++
 5 files changed, 80 insertions(+), 1 deletion(-)
 create mode 100644 daemon/config/cc-daemon.go

diff --git a/cmd/dockerd/config_common_unix.go b/cmd/dockerd/config_common_unix.go
index b29307b59..851ddd994 100644
--- a/cmd/dockerd/config_common_unix.go
+++ b/cmd/dockerd/config_common_unix.go
@@ -29,6 +29,6 @@ func installUnixConfigFlags(conf *config.Config, flags *pflag.FlagSet) {
 	flags.BoolVar(&conf.BridgeConfig.InterContainerCommunication, "icc", true, "Enable inter-container communication")
 	flags.Var(opts.NewIPOpt(&conf.BridgeConfig.DefaultIP, "0.0.0.0"), "ip", "Default IP when binding container ports")
 	flags.Var(opts.NewNamedRuntimeOpt("runtimes", &conf.Runtimes, config.StockRuntimeName), "add-runtime", "Register an additional OCI compatible runtime")
-	flags.StringVar(&conf.DefaultRuntime, "default-runtime", config.StockRuntimeName, "Default OCI runtime for containers")
+	flags.StringVar(&conf.DefaultRuntime, "default-runtime", "", "Default OCI runtime for containers")
 
 }
diff --git a/cmd/dockerd/daemon.go b/cmd/dockerd/daemon.go
index 56405541b..9e8ca9b46 100644
--- a/cmd/dockerd/daemon.go
+++ b/cmd/dockerd/daemon.go
@@ -132,6 +132,7 @@ func (cli *DaemonCli) start(opts daemonOptions) (err error) {
 			getDaemonConfDir(cli.Config.Root),
 			cliflags.DefaultTrustKeyFile)
 	}
+	config.SelectDefaultRuntime(cli.Config)
 
 	if cli.Config.Debug {
 		debug.Enable()
diff --git a/daemon/config/cc-daemon.go b/daemon/config/cc-daemon.go
new file mode 100644
index 000000000..28a4775de
--- /dev/null
+++ b/daemon/config/cc-daemon.go
@@ -0,0 +1,69 @@
+package config
+
+import (
+	"github.com/Sirupsen/logrus"
+	"github.com/docker/docker/api/types"
+	"os"
+	"os/exec"
+)
+
+const (
+	clearContainersRuntimeName   = "cor"
+	clearContainersRuntimeBinary = "cc-oci-runtime"
+)
+
+func hasKVM() bool {
+	if _, err := os.Stat("/dev/kvm"); err == nil {
+		return true
+	}
+	return false
+}
+
+func hasClearContainers() bool {
+	if _, err := exec.LookPath(clearContainersRuntimeBinary); err == nil {
+		return true
+	}
+	return false
+
+}
+
+// SetupClearContainersRuntime will register clear-containers runtime if:
+// - kvm is enabled
+// - Clear Containers runtime is installed
+// - Clear Containers runtime was not registered previously
+func SetupClearContainersRuntime(config *Config) bool {
+
+	runtimes := config.GetAllRuntimes()
+	_, ok := runtimes[clearContainersRuntimeName]
+	if !ok && hasKVM() && hasClearContainers() {
+		ccRuntime := types.Runtime{Path: clearContainersRuntimeBinary}
+		config.Runtimes[clearContainersRuntimeName] = ccRuntime
+		return true
+	}
+	return false
+}
+
+// SelectDefaultRuntime will choose  what runtime use:
+// - If default runtime defined, do nothing
+// Clear Containers is default if:
+// - clear-containers runtime is registered
+// - No default runtime was explicitly defined
+// stockRuntimeName (runc ) is default if :
+// Otherwise stockRuntimeName will be default
+func SelectDefaultRuntime(config *Config) {
+
+	if config.DefaultRuntime != "" {
+		logrus.Infof("Using defined Default rutime (%s)", config.DefaultRuntime)
+		return
+	}
+
+	runtimes := config.GetAllRuntimes()
+	if _, ccRegistered := runtimes[clearContainersRuntimeName]; ccRegistered {
+		config.DefaultRuntime = clearContainersRuntimeName
+		logrus.Infof("Using Clear Containers (%s) as Default rutime", config.DefaultRuntime)
+		return
+	}
+	config.DefaultRuntime = StockRuntimeName
+	logrus.Infof("Using %s as Default rutime", config.DefaultRuntime)
+	return
+}
diff --git a/daemon/config/config.go b/daemon/config/config.go
index 134fc671d..747136666 100644
--- a/daemon/config/config.go
+++ b/daemon/config/config.go
@@ -493,6 +493,11 @@ func Validate(config *Config) error {
 		}
 	}
 
+	// Add Clear containers runtime if possible
+	if SetupClearContainersRuntime(config) {
+		logrus.Infof("Clear Containers runtime added")
+	}
+
 	if defaultRuntime := config.GetDefaultRuntimeName(); defaultRuntime != "" && defaultRuntime != StockRuntimeName {
 		runtimes := config.GetAllRuntimes()
 		if _, ok := runtimes[defaultRuntime]; !ok {
diff --git a/daemon/daemon_unix.go b/daemon/daemon_unix.go
index 0f342bcfd..1a7df435d 100644
--- a/daemon/daemon_unix.go
+++ b/daemon/daemon_unix.go
@@ -562,6 +562,10 @@ func verifyPlatformContainerSettings(daemon *Daemon, hostConfig *containertypes.
 			return warnings, fmt.Errorf("cgroup-parent for systemd cgroup should be a valid slice named as \"xxx.slice\"")
 		}
 	}
+	logrus.Info("Runtime:")
+	logrus.Info(hostConfig.Runtime)
+	logrus.Info("Default Runtime:")
+	logrus.Info(daemon.configStore.GetDefaultRuntimeName())
 	if hostConfig.Runtime == "" {
 		hostConfig.Runtime = daemon.configStore.GetDefaultRuntimeName()
 	}
-- 
2.13.0

